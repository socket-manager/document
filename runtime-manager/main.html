<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>メイン処理クラスの実装 | RuntimeManager | SOCKET-MANAGER Framework For PHP</title>
        <meta name="description" content="ランタイムライブラリ（RuntimeManager）におけるメイン処理クラスの実装方法を解説。サーバー識別子/コマンド説明文/設定可能項目や構築方法を具体的なコード例と共に紹介。" />
        <meta content="SOCKET-MANAGER,RuntimeManager,ランタイムライブラリ,常駐型アプリ,イベントループ,コルーチン,ステータス管理,PHPフレームワーク" name="keywords">
        <link rel="canonical" href="https://socket-manager.github.io/document/runtime-manager/main.html" />

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF9W695NNW"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-LF9W695NNW');
        </script>
        <link rel="icon" href="https://socket-manager.github.io/document/favicon.ico" type="image/x-icon" />
        <link type="text/css" rel="stylesheet" href="../css/common.css" media="all" />
        <script src="../js/jquery-3.7.1.min.js"></script>
        <script type="text/javascript" src="../js/common.js"></script>
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "TechArticle",
            "headline": "ランタイムライブラリ（RuntimeManager） - メイン処理クラスの実装ガイド",
            "description": "ランタイムライブラリ（RuntimeManager）におけるメイン処理クラスの実装方法を解説。サーバー識別子/コマンド説明文/設定可能項目や構築方法を具体的なコード例と共に紹介。",
            "keywords": "SOCKET-MANAGER, RuntimeManager, ランタイムライブラリ, 常駐型アプリ, イベントループ, コルーチン, ステータス管理, PHPフレームワーク",
            "articleSection": ["Technical Documentation", "Runtime Services", "PHP Programming"],
            "author": {
                "@type": "Person",
                "name": "SOCKET-MANAGER開発チーム"
            },
            "publisher": {
                "@type": "Organization",
                "name": "SOCKET-MANAGER",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://socket-manager.github.io/document/logo.png",
                    "width": 355,
                    "height": 50
                }
            },
            "mainEntityOfPage": {
                "@type": "TechArticle",
                "@id": "https://socket-manager.github.io/document/runtime-manager/main.html"
            },
            "url": "https://socket-manager.github.io/document/runtime-manager/main.html",
            "breadcrumb": {
                "@type": "BreadcrumbList",
                "itemListElement": [
                    {
                        "@type": "ListItem",
                        "position": 1,
                        "name": "Framework Top",
                        "item": "https://socket-manager.github.io/document/"
                    },{
                        "@type": "ListItem",
                        "position": 2,
                        "name": "RuntimeManagerのご紹介",
                        "item": "https://socket-manager.github.io/document/runtime-manager/"
                    },{
                        "@type": "ListItem",
                        "position": 3,
                        "name": "メイン処理クラスの実装",
                        "item": "https://socket-manager.github.io/document/runtime-manager/main.html"
                    }
                ]
            },
            "isPartOf": {
                "@type": "WebSite",
                "name": "RuntimeManagerのご紹介",
                "url": "https://socket-manager.github.io/document/runtime-manager/"
            }
        }
        </script>
    </head>
    <body>
        <div class="layout">
            <div class="menu" role="navigation" aria-label="ページメニュー">
                <h2 class="menu-title">SOCKET-MANAGER</h2>
                <h4 class="menu-reference menu-page-title-bottom"><a href="../index.html" target="_blank">&gt;&gt; Framework Top</a></h4>
                <h2 class="menu-label">MAIN-MENU</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./index.html">▶RuntimeManagerのご紹介</a></h3>

                    <h3 class="menu-page-title-link"><a href="./event-handler.html">▶イベントハンドラについて</a></h3>

                </div>
                <h3 class="menu-label-sub">IMPLEMENT</h3>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./init-class.html">▶初期化クラス</a></h3>

                    <h3 class="menu-page-title-link"><a href="./unit-parameter.html">▶UNITパラメータクラス</a></h3>

                    <h3 class="menu-page-title-link"><a href="./runtime-unit.html">▶ランタイムUNITクラス</a></h3>

                    <h3 class="menu-page-title">▼メイン処理クラス</h3>

                    <ul>
                        <li><a href="./main.html#begin">はじめに</a></li>
                    </ul>
                    <ul>
                        <li><a href="./main.html#identifier">アプリケーション識別子</a></li>
                    </ul>
                    <ul>
                        <li><a href="./main.html#description">コマンド説明文</a></li>
                    </ul>
                    <ul>
                        <li><a href="./main.html#setting">設定可能項目</a></li>
                    </ul>
                    <ul>
                        <li><a href="./main.html#class">クラス適用項目</a></li>
                    </ul>
                    <ul>
                        <li><a href="./main.html#last">おわりに</a></li>
                    </ul>

                </div>
                <h3 class="menu-label-sub">ADVANCED</h3>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="../laravel.html" target="_blank">▶Laravelと連携する</a></h3>

                    <h3 class="menu-page-title-link"><a href="../system-setting.html" target="_blank">▶システム設定ファイル</a></h3>

                </div>
                <div class="menu-dummy-for-runtime"></div>
            </div>
            <div class="main" role="main">

                <h1>【メイン処理クラスの実装】</h1>

                <a id="begin"></a>
                <h2 class="subtitle">はじめに</h2>
                <div class="text-block">
                    このクラスはアプリケーションのエントリポイントとして機能し、RuntimeManagerクラスをインスタンス化して実行するまでの処理が含まれています。<br />
                    専用のコマンドを使ってスキャフォールディングできるので、メイン処理をコーディングする必要はなく、組み換え可能なランタイムUNIT（ビジネスロジック）部のクラスを適用して使用します。
                    SocketManagerクラスとは異なり、プロトコル部は不要なので、より簡易的な実装になります。<br /><br />

                    ここではコマンドを実行してメイン処理クラスを生成した後、そのクラスを使ってカスタマイズできる内容を中心にご紹介します。<br /><br />

                    メイン処理クラスを生成するコマンドは以下の通り。<br />

                    <pre color-change="command" aria-label="コマンド実行（MainForTestというクラス名を指定する場合）">
> php worker runtime:main MainForTest

[success] メイン処理クラスの生成に成功しました (MainForTest)
                    </pre><br />
                    生成されたクラスは<code>app/MainClass</code>の場所に<code>MainForTest.php</code>というファイル名で格納されます。<br />

                    新しいメイン処理クラスが増えるとUsageの<code>main</code>カテゴリに項目が追加されます。<br />
                    <pre color-change="command" aria-label="Usageの表示">
> php worker
SOCKET-MANAGER Framework 1.16.0

Usage:
  command [arguments]

 main
  app:main-for-test                              Command description
 craft
  craft:init <初期化クラス名>                     初期化クラスの生成
  craft:parameter &lt;UNITパラメータクラス名&gt;        UNITパラメータクラスの生成
  craft:protocol <プロトコルUNIT定義のクラス名>   プロトコルUNIT定義のクラスとステータス名Enumの生成
  craft:command <コマンドUNIT定義のクラス名>      コマンドUNIT定義のクラスとキュー／ステータス名Enumの生成
  craft:main <メイン処理のクラス名>               メイン処理クラスの生成
  craft:setting <設定ファイル名>                  設定ファイルの生成
  craft:locale <メッセージファイル名>             メッセージファイルの生成
 runtime
  runtime:init <初期化クラス名>                   初期化クラスの生成
  runtime:parameter &lt;UNITパラメータクラス名&gt;      UNITパラメータクラスの生成
  runtime:units <ランタイムUNIT定義のクラス名>    ランタイムUNIT定義のクラスとキュー／ステータス名Enumの生成
  runtime:main <メイン処理のクラス名>             メイン処理クラスの生成
                    </pre><br />

                    上記Usageのように<code>main</code>カテゴリに<code>app:main-for-test</code>という名前で追加されているのが確認できます。<br />
                </div><br />

                <a id="identifier"></a>
                <h2 class="subtitle">アプリケーション識別子</h2>
                <div class="text-block">
                    メイン処理クラスが生成されると以下のプロパティが確認できます。<br />
                    <pre color-change="php" aria-label="プロパティのメンバ">
/**
 * @var string $identifer アプリケーション識別子
 */
protected string $identifer = 'app:main-for-test';
                    </pre><br />

                    ここではコマンドラインフォーマットを定義しています。<br />
                    <code>app:main-for-test</code>の部分がアプリケーション（プロセス）名で、コマンドパラメータを含めて自由にカスタマイズできます。<br /><br />

                    例えばサービス管理ランチャーを実装する場合、start（起動）やstop（停止）などのアクション名とサービス名は以下のように定義できます。<br />
                    <pre color-change="php" aria-label="アクション名やサービス名のパラメータを追加">
/**
 * @var string $identifer アプリケーション識別子
 */
protected string $identifer = 'app:main-for-test <font class="pre-yellow">{action} {service?}</font>';
                    </pre><br />

                    <code>service</code>の後ろに付いている"はてな（?）マーク"は省略可能である事を表しています。<br />
                    ちなみに"はてな（?）マーク"は最後尾の連続したパラメータにしか指定できません。<br />
                    例えば<code>{action?} {service?}</code>と書く事はできますが<code>{action?} {service}</code>と書く事はできません。<br /><br />

                    なお、メイン処理クラス内では<code>$this->getParameter('action')</code>のように書く事でパラメータを取得できます。<br />
                    省略可能なパラメータが省略されている時はnullが返却されます。<br />
                </div><br />

                <a id="description"></a>
                <h2 class="subtitle">コマンド説明文</h2>
                <div class="text-block">
                    メイン処理クラスが生成されると以下のプロパティが確認できます。<br />
                    <pre color-change="php" aria-label="プロパティのメンバ">
/**
 * @var string $description コマンド説明
 */
protected string $description = 'Command description';
                    </pre><br />

                    ここではUsageを表示した時のサーバーコマンドの説明文を定義しています。<br />
                    初期状態では<code>Command description</code>となっているので、これをプロパティで変更できます。<br />
                    例えば以下のように変更すると<br />

                    <pre color-change="php" aria-label="説明文の変更">
/**
 * @var string $description コマンド説明
 */
protected string $description = 'テスト用のアプリ';
                    </pre><br />

                    Usageでは以下のように表示されます。<br />
                    <pre color-change="command" aria-label="Usageの表示">
> php worker
SOCKET-MANAGER Framework 1.16.0

Usage:
  command [arguments]

 main
  app:main-for-test                              テスト用のアプリ
 craft
  craft:init <初期化クラス名>                     初期化クラスの生成
  craft:parameter &lt;UNITパラメータクラス名&gt;        UNITパラメータクラスの生成
  craft:protocol <プロトコルUNIT定義のクラス名>   プロトコルUNIT定義のクラスとステータス名Enumの生成
  craft:command <コマンドUNIT定義のクラス名>      コマンドUNIT定義のクラスとキュー／ステータス名Enumの生成
  craft:main <メイン処理のクラス名>               メイン処理クラスの生成
  craft:setting <設定ファイル名>                  設定ファイルの生成
  craft:locale <メッセージファイル名>             メッセージファイルの生成
 runtime
  runtime:init <初期化クラス名>                   初期化クラスの生成
  runtime:parameter &lt;UNITパラメータクラス名&gt;      UNITパラメータクラスの生成
  runtime:units <ランタイムUNIT定義のクラス名>    ランタイムUNIT定義のクラスとキュー／ステータス名Enumの生成
  runtime:main <メイン処理のクラス名>             メイン処理クラスの生成
                    </pre><br />
                </div><br />

                <a id="setting"></a>
                <h2 class="subtitle">設定可能項目</h2>
                <div class="text-block">
                    このメイン処理クラスであらかじめ設定可能な項目は、<code>RuntimeManager</code>クラスの引数とそのクラス内の<code>cycleDriven</code>メソッドの引数です。<br />
                    各引数の設定方法には以下の３種類があります。<br />
<dl>
    <dt>①メイン処理クラス内で直接指定</dt>
    <dd>この項目でご紹介する方法です。</dd>
    <dt>②コマンドラインから取得</dt>
    <dd>上記の<font><a href="./main.html#property">&gt;&gt; アプリケーション識別子</a></font>の項目でご紹介した方法です。</dd>
    <dt>③設定ファイル</dt>
    <dd><font><a href="../setting.html" target="_blank">▶設定ファイル</a></font>のページでご紹介している方法です。</dd>
</dl>

                    <br />
                    <h3 class="underline">RuntimeManagerクラスの引数</h3>

                    RuntimeManagerクラスの引数は以下の一つのみです。<br />

                    <pre aria-label="RuntimeManagerクラスの引数">
１）キュー名（デフォルト：RuntimeQueueEnum::STARTUP->value）
                    </pre><br />

                    この引数には最初に実行されるキュー名を指定できます。<br />

                    <br />
                    <h3 class="underline">cycleDrivenメソッドの引数</h3>

                    メイン処理クラスの実行（exec）メソッド末尾のソースにはノンブロッキングループ内で<code>cycleDriven</code>メソッドが呼ばれている箇所があります。<br />

                    <pre color-change="php" aria-label="実行処理の末尾部分">
public function exec()
{
    ・
    ・
    ・

    // ノンブロッキングループ
    while(true)
    {
        // 周期ドリブン
        $ret = $manager->cycleDriven();
        if($ret === false)
        {
            goto finish;
        }
    }

    ・
    ・
    ・
}
                    </pre><br />

                    この<code>cycleDriven</code>メソッドの引数は以下の一つのみです。<br />

                    <pre aria-label="cycleDrivenメソッドの引数">
１）周期インターバルタイム（デフォルト：2000μs）
                    </pre><br />

                    この引数をデフォルト値で指定すると以下のようになります。<br />

                    <pre color-change="php" aria-label="直接引数へ値を指定するパターン">
$manager->cycleDriven( 2000 );
                    </pre><br />

                    <pre color-change="php" aria-label="引数指定を省略する事によるデフォルト値の適用">
$manager->cycleDriven();
                    </pre><br />

                    御覧の通り、直接値を指定する事もできますが、引数を省略しても自動的にデフォルト値が適用される仕組みになっています。<br />
                </div><br />

                <a id="class"></a>
                <h2 class="subtitle">クラス適用項目</h2>
                <div class="text-block">
                    メイン処理クラスの実行（exec）メソッドの中ほどに以下のコメント部分があります。<br />

                    <pre color-change="php" aria-label="実行処理の中腹部分">
public function exec()
{
    ・
    ・
    ・

    /**
     * 初期化クラスの設定
     * 
     * $manager_runtime->setInitRuntimeManager()メソッドで初期化クラスを設定します
     */

    /**
     * ランタイムUNITの設定
     * 
     * $manager_runtime->setRuntimeUnits()メソッドでランタイムUNITクラスを設定します
     */

    ・
    ・
    ・
}
                    </pre><br />

                    あらかじめ作成しておいた初期化クラス／ランタイムUNITクラスのインスタンスは、ここで以下のように引き渡してフレームワークライブラリへ適用します。

                    <pre color-change="php" aria-label="各クラスの適用">
public function exec()
{
    ・
    ・
    ・

    /**
     * 初期化クラスの設定
     */
    $manager->setInitRuntimeManager(new InitForTest());

    /**
     * ランタイムUNITの設定
     */
    $manager->setRuntimeUnits(new ProtocolForTest());

    ・
    ・
    ・
}
                    </pre><br />

                    あらかじめ複数のランタイムUNITクラスを用意している場合は、この部分を組み替える事によってビジネスロジックを変更する事が可能になります。<br />
                </div><br />

                <a id="last"></a>
                <h2 class="subtitle">おわりに</h2>
                <div class="text-block">
                    これまで見てきたように、メイン処理クラスではコマンドライン／設定項目／ランタイムUNITの組み合わせを自由にデザインすることができます。<br />
                    また、サーバー間通信のような通信処理が必要な場合は、SocketManagerクラスの<font><a href="../main.html" target="_blank">▶メイン処理クラス</a></font>のページでご紹介していたような構成にする事で、統一されたインターフェースで実装する事が可能です。<br />
                </div>
            </div>
        </div>
    </body>
</html>
