<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>Websocket開発環境 | SOCKET-MANAGER Framework For PHP</title>
        <meta name="description" content="Websocketサーバーの開発環境を利用するための方法をご紹介します" />
        <meta content="PHP,ソケット通信,websocket,フレームワーク,サーバー" name="keywords">

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF9W695NNW"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-LF9W695NNW');
        </script>
        <link rel="icon" href="./favicon.ico" type="image/x-icon" />
        <link type="text/css" rel="stylesheet" href="././css/common.css" media="all" />
        <script src="././js/jquery-3.7.1.min.js"></script>
        <script type="text/javascript" src="././js/common.js"></script>
    </head>
    <body>
        <div class="layout">
            <div class="menu">
                <h2 class="menu-title">SOCKET-MANAGER</h2>
                <h4 class="menu-reference menu-page-title-link"><a href="./reference/index.html" target="blank">&gt;&gt; Reference</a></h4>
                <h2 class="menu-label">MAIN-MENU</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./index.html">▶フレームワークのご紹介</a></h3>

                    <h3 class="menu-page-title">▼Websocket開発環境</h3>

                    <ul>
                        <li><a href="./websocket.html#begin">はじめに</a></li>
                    </ul>
                    <ul>
                        <li><a href="./websocket.html#install">インストール</a></li>
                    </ul>
                    <ul>
                        <li><a href="./websocket.html#implementation">実装例</a></li>
                    </ul>
                    <ul>
                        <li><a href="./websocket.html#run">動作確認</a></li>
                    </ul>
                    <ul>
                        <li><a href="./websocket.html#log">ログ出力について</a></li>
                    </ul>
                    <ul>
                        <li><a href="./websocket.html#last">おわりに</a></li>
                    </ul>

                    <h3 class="menu-page-title-link"><a href="./new-project.html">▶新規プロジェクト開発環境</a></h3>

                    <h3 class="menu-page-title-link"><a href="./laravel.html">▶Laravelと連携する</a></h3>

                    <h3 class="menu-page-title-link"><a href="./architecture.html">▶アーキテクチャ</a></h3>

                    <h3 class="menu-page-title-link"><a href="./multi-server.html">▶マルチサーバーの構成</a></h3>
                </div>
                <h2 class="menu-label">EXTRA-MENU</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./extra-demo.html">▶デモサーバーの種類</a></h3>

                    <h3 class="menu-page-title-link"><a href="./extra-demo-command.html">▶デモのコマンド仕様</a></h3>

                    <h3 class="menu-page-title-link"><a href="./extra-minecraft.html">▶マインクラフトの通信仕様</a></h3>

                    <h3 class="menu-page-title-link"><a href="./extra-close-frame.html">▶切断フレームの検証</a></h3>

                </div>
            </div>
            <div class="main">

                <h1>【Websocket開発環境】</h1>

                <a id="begin"></a>
                <h2 class="subtitle">はじめに</h2>

                <div class="text-block">
                    この環境はデモ版のWebsocketサーバーからコマンド部を含めWebsocketに不要な部分を取り除いて再構築したものです。<br />
                    プロトコルの主要な部分は実装済みなので、コマンド部を自分で作成しながらブラウザを使って動作確認できますので、新規でプロジェクトを起こす場合に比べてソケット通信初心者向けの環境と言えます。<br /><br />

                    以降ではインストール方法と実装例を見ながら進めていきます。
                </div><br />

                <a id="install"></a>
                <h2 class="subtitle">インストール</h2>

                <div class="text-block">
                    以下のコマンドでインストールできます。<br />
                    ※GitHubから直接ダウンロードする場合は<font><a href="https://github.com/socket-manager/websocket-project" target="_blank">&gt;&gt; こちら</a></font>からどうぞ。<br />

                    <span>Websocket開発環境のインストール</span>
                    <pre color-change="command">
> composer create-project socket-manager/websocket-project <インストール先のディレクトリ名>
                    </pre><br />

                    それでは上記でインストールしたプロジェクトルートに移動して<code>php worker</code>コマンドを実行してみます。<br />
                    <span>Usage表示</span>
                    <pre color-change="command">
> php worker

SOCKET-MANAGER Framework 1.0.0
Usage:
  command [arguments]

 main
  app:websocket-server                           Websocketサーバー
 craft
  craft:init <初期化クラス名>                     初期化クラスの生成
  craft:parameter &lt;UNITパラメータクラス名&gt;        UNITパラメータクラスの生成
  craft:protocol <プロトコルUNIT定義のクラス名>   プロトコルUNIT定義のクラスとステータス名Enumの生成
  craft:command <コマンドUNIT定義のクラス名>      コマンドUNIT定義のクラスとキュー／ステータス名Enumの生成
  craft:main <メイン処理のクラス名>               メイン処理クラスの生成
 laravel
  laravel:command <メイン処理のクラス名>          Laravelコマンドクラスの生成
                    </pre><br />

                    ご覧のように<code>app:websocket-server</code>が含まれている事が確認できます。<br />
                    これを以下のように実行する事でサーバーを起動できます。<br />

                    <span>Websocketサーバーの起動</span>
                    <pre color-change="command">
> php worker app:websocket-server <ポート番号>
                    </pre><br />

                    ※コマンドの詳しい使い方は<font class="code"><a href="./new-project.html" target="_blank">▶新規プロジェクト開発環境</a></font>のページでご紹介しています。
                </div><br />

                <a id="implementation"></a>
                <h2 class="subtitle">実装例</h2>

                <div class="text-block">
                    ここではコマンド部のチャットメッセージを実装してみます。<br /><br />

                    <h3 class="underline">クライアントの実装</h3>

                    このプロジェクトでは<code>client</code>ディレクトリに検証用として最低限の実装でファイルを同梱しています。<br />
                    それでは<code>client</code>ディレクトリ内の<code>test.js</code>を編集します。<br />
                    <code>test.js</code>内には以下のように<code>onopen</code>メソッドがあるのでここに処理を入れます。<br />
                    以下の黄色の部分が今回追加したソースです。<br />

                    <span>onopenメソッドの実装:app/client/test.js</span>
                    <pre color-change="php">
// Websocket接続
websocket = new WebSocket(uri);

/**
 * 接続完了イベント
 * 
 * @param {*} event イベントインスタンス
 * @returns 
 */
websocket.onopen = function(event)
{
    <font class="pre-yellow">let data =
    {
          'cmd': 'message'
        , 'comment': 'テスト'
    };
    websocket.send(JSON.stringify(data));</font>
};
                    </pre><br />

                    <code>onopen</code>メソッドはWebsocketの接続が確立した時に呼び出されるイベントです。<br />
                    上記のようにコマンド名は<code>message</code>、送信コメントは<code>テスト</code>にしてJSONデータを送信する処理を入れています。<br /><br />

                    そして以下のように<code>onmessage</code>メソッドで受信したデータを受け取れますので受信したデータはコンソールに表示されるようになっています。<br />

                    <span>onmessageメソッド:app/client/test.js</span>
                    <pre color-change="php">
/**
 * データ受信イベント
 * 
 * @param {*} event イベントインスタンス
 * @returns 
 */
websocket.onmessage = function(event)
{
    let data = JSON.parse(event.data);

    console.dir(data);
};
                    </pre><br />

                    <h3 class="underline">サーバーの実装</h3>

                    まずは<code>CommandForWebsocketQueueEnum.php</code>のファイルに今回追加するコマンド名を定義します。<br />
                    以下の黄色の部分が今回追加したソースです。<br />

                    <span>キュー名の追加：app/CommandUnits/CommandForWebsocketQueueEnum.php</span>
                    <pre color-change="php">
&lt;?php
/**
 * コマンド部のキュー名のENUMファイル
 * 
 * Websocket用
 */

namespace App\CommandUnits;


/**
 * コマンド部のキュー名定義
 * 
 * Websocket用
 */
enum CommandForWebsocketQueueEnum: string
{
    <font class="pre-yellow">case MESSAGE = 'message';</font>
}
                    </pre><br />

                    次に<code>CommandForWebsocket.php</code>を編集します。<br />
                    以下の黄色の部分が今回追加したソースです。<br />

                    <span>ステータスUNITの実装:app/CommandUnits/CommandForWebsocket.php</span>
                    <pre color-change="php">
class CommandForWebsocket implements IEntryUnits
{
    /**
     * @var const QUEUE_LIST キュー名のリスト
     */
    protected const QUEUE_LIST = [
        <font class="pre-yellow">CommandForWebsocketQueueEnum::MESSAGE->value,</font>
    ];

    /**
     * キューリストの取得
     * 
     * @return array キュー名のリスト
     */
    public function getQueueList(): array
    {
        return (array)static::QUEUE_LIST;
    }

    /**
     * ステータスUNITリストの取得
     * 
     * @param string $p_que キュー名
     * @return array キュー名に対応するUNITリスト
     */
    public function getUnitList(string $p_que): array
    {
        <font class="pre-yellow">$ret = [];

       &nbsp;if($p_que === CommandForWebsocketQueueEnum::MESSAGE->value)
        {
            $ret[] = [
                'status' => CommandForWebsocketStatusEnum::START->value,
                'unit' =>&nbsp;$this->getMessageStart()
            ];
        }

       &nbsp;return $ret;</font>
    }

    <font class="pre-yellow">protected&nbsp;function getMessageStart()
    {
       &nbsp;return&nbsp;function(ParameterForWebsocket $p_param):&nbsp;?string
        {
            $p_param->logWriter('debug', ['COMMAND:MESSAGE' => 'START']);

            $w_ret = $p_param->getRecvData();
            $msg = $w_ret['data'];

            $data =
            [
                'data' => $msg
            ];
            $p_param->setSendStackAll($data);

           &nbsp;return&nbsp;null;
        };
    }</font>
}
                    </pre><br />

                    追加したポイントは以下の通り。<br />

                    <dl>
                        <dt>■QUEUE_LISTへEnum値を追加</dt>
                        <dd><code>MESSAGE</code>というキュー名を追加</dd>
                        <dt>■getUnitListメソッドの実装</dt>
                        <dd><code>MESSAGE</code>コマンドに対応する<font class="code"><a href="./architecture.html#que_and_unit" target="_blank">UNIT</a></font>（メソッド）処理を登録</dd>
                        <dt>■getMessageStartメソッドの実装（※）</dt>
                        <dd>受信したデータを配信する処理を実装（上記ソース内のlogWriterメソッドでログ出力できます）</dd>
                    </dl>

                    ※引数の<code>ParameterForWebsocket</code>クラスは<code>SocketManagerParameter</code>クラスを継承しています。詳しくは<code>SocketManagerParameter</code>クラスの<font class="code"><a href="./reference/classes/SocketManager-Library-SocketManagerParameter.html" target="_blank">&gt;&gt; Reference</a></font>をご覧ください。
                </div><br />

                <a id="run"></a>
                <h2 class="subtitle">動作確認</h2>

                <div class="text-block">
                    以下のコマンドを実行してサーバーを10000ポートで起動します。<br />

                    <span>Websocketサーバーの起動</span>
                    <pre color-change="command">
> php worker app:websocket-server 10000
                    </pre><br />

                    次にクライアントをブラウザで開きます。<br />
                    <code>client/test.html</code>をブラウザへドラッグ＆ドロップした上でF12を押して以下の画面を開いてください。<br />
                    <img src="./img/websocket/browser.png" /><br /><br />

                    この状態で接続ボタンをクリックすると以下のようにコンソール画面でメッセージコマンドが返ってきている事が確認できます。<br />
                    <img src="./img/websocket/browser_exec.png" /><br /><br />

                    そしてさらにブラウザをもう一つ開いて同じ操作をすると二つのブラウザウインドウに同じメッセージが配信されている事が確認できますので色々と試してみてください。<br />
                </div><br />

                <a id="log"></a>
                <h2 class="subtitle">ログ出力について</h2>

                <div class="text-block">
                    以下のディレクトリ構成でログファイルが出力されます。<br />

                    <span>ログ出力先のディレクトリ</span>
                    <pre>
/logs
    /socket-manager-log     Websocketサーバーのログ
                    </pre><br />

                    ファイルの命名規則は次の通り。<br />

                    <dl>
                        <dt>■Websocketサーバーのログ</dt>
                        <dd>&lt;日付文字列（"Ymd"形式）&gt;_W&lt;ポート番号&gt;.log</dd>
                    </dl>
                </div><br />

                <a id="last"></a>
                <h2 class="subtitle">おわりに</h2>

                <div class="text-block">
                    コマンドUNITの処理は上記で実装したように以下の流れが基本となります。<br />

                    <dl>
                        <dt>１．受信データの取得</dt>
                        <dd>getRecvDataメソッドで取得</dd>
                        <dt>２．送信データの作成</dt>
                        <dd>シリアライズ前のデータを作成する</dd>
                        <dt>３．送信データの設定</dt>
                        <dd>setSendStack、setSendStackAllメソッドで設定</dd>
                    </dl>

                    Websocket開発環境では上記のようにコマンド部の処理を追加していく事でサーバーコンテンツを作成していく事になります。<br />
                    （<font><a href="./architecture.html" target="_blank">▶アーキテクチャ</a></font>を理解しておいた方がより高度な実装が可能になります）<br /><br />

                    自作のプロトコルを実装する必要がある場合は<font><a href="./new-project.html" target="_blank">▶新規プロジェクト開発環境</a></font>をご利用ください。
                </div>
            </div>
        </div>
    </body>
</html>
