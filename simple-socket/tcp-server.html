<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>TCP サーバーの実装 | シンプルソケット機能 | SOCKET-MANAGER Framework For PHP</title>
        <meta name="description" content="SOCKET‑MANAGER Framework の SimpleSocket を使った TCP サーバー実装ガイド。`SimpleSocketGenerator` の初期設定、cycleDriven を使ったノンブロッキング処理、ログライターや SocketManager 連携、常時実行コールバック例を丁寧に解説します。" />
        <meta content="TCPサーバー, SimpleSocket, SOCKET-MANAGER, PHP, ノンブロッキング, SimpleSocketGenerator, サーバー実装, IPC, ログライター" name="keywords">
        <link rel="canonical" href="https://socket-manager.github.io/document/simple-socket/tcp-server.html" />

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF9W695NNW"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-LF9W695NNW');
        </script>
        <link rel="icon" href="https://socket-manager.github.io/document/favicon.ico" type="image/x-icon" />
        <link type="text/css" rel="stylesheet" href="../css/common.css" media="all" />
        <script src="../js/jquery-3.7.1.min.js"></script>
        <script type="text/javascript" src="../js/common.js"></script>
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@graph": [
                {
                    "@type": "TechArticle",
                    "headline": "SOCKET-MANAGER Framework - シンプルソケット機能：TCP サーバー実装ガイド",
                    "description": "SOCKET‑MANAGER Framework の SimpleSocket を使った TCP サーバー実装ガイド。`SimpleSocketGenerator` の初期設定、cycleDriven を使ったノンブロッキング処理、ログライターや SocketManager 連携、常時実行コールバック例を丁寧に解説します。",
                    "keywords": "TCPサーバー, SimpleSocket, SOCKET-MANAGER, PHP, ノンブロッキング, SimpleSocketGenerator, サーバー実装, IPC, ログライター",
                    "articleSection": ["Technical Documentation", "Networking", "Server Implementation", "PHP Programming"],
                    "author": {
                        "@type": "Person",
                        "name": "SOCKET-MANAGER開発チーム"
                    },
                    "publisher": {
                        "@type": "Organization",
                        "name": "SOCKET-MANAGER",
                        "logo": {
                            "@type": "ImageObject",
                            "url": "https://socket-manager.github.io/document/logo.png",
                            "width": 355,
                            "height": 50
                        }
                    },
                    "mainEntityOfPage": {
                        "@type": "TechArticle",
                        "@id": "https://socket-manager.github.io/document/simple-socket/tcp-server.html"
                    },
                    "url": "https://socket-manager.github.io/document/simple-socket/tcp-server.html",
                    "breadcrumb": {
                        "@type": "BreadcrumbList",
                        "itemListElement": [{
                            "@type": "ListItem",
                            "position": 1,
                            "name": "Framework Top",
                            "item": "https://socket-manager.github.io/document/"
                        },{
                            "@type": "ListItem",
                            "position": 2,
                            "name": "シンプルソケット機能",
                            "item": "https://socket-manager.github.io/document/simple-socket/"
                        },{
                            "@type": "ListItem",
                            "position": 3,
                            "name": "TCP サーバーの実装",
                            "item": "https://socket-manager.github.io/document/simple-socket/tcp-server.html"
                        }]
                    },
                    "isPartOf": {
                        "@type": "WebSite",
                        "name": "シンプルソケット機能",
                        "url": "https://socket-manager.github.io/document/simple-socket/"
                    }
                },
                {
                    "@type": "ItemList",
                    "@id": "https://socket-manager.github.io/document/simple-socket/",
                    "name": "SOCKET-MANAGER Framework - シンプルソケットシリーズ",
                    "about": {
                        "@id": "https://socket-manager.github.io/document/simple-socket/"
                    },
                    "itemListOrder": "http://schema.org/ItemListOrderAscending",
                    "numberOfItems": 11,
                    "itemListElement": [
                        {
                            "@type": "ListItem",
                            "position": 1,
                            "url": "https://socket-manager.github.io/document/simple-socket/",
                            "name": "シンプルソケット機能"
                        },
                        {
                            "@type": "ListItem",
                            "position": 2,
                            "url": "https://socket-manager.github.io/document/simple-socket/tcp-server.html",
                            "name": "TCP サーバーの実装"
                        },
                        {
                            "@type": "ListItem",
                            "position": 3,
                            "url": "https://socket-manager.github.io/document/simple-socket/tcp-client.html",
                            "name": "TCP クライアントの実装"
                        },
                        {
                            "@type": "ListItem",
                            "position": 4,
                            "url": "https://socket-manager.github.io/document/simple-socket/udp.html",
                            "name": "UDP 通信の実装"
                        },
                        {
                            "@type": "ListItem",
                            "position": 5,
                            "url": "https://socket-manager.github.io/document/simple-socket/new-project.html",
                            "name": "SimpleSocketの新規開発環境"
                        },
                        {
                            "@type": "ListItem",
                            "position": 6,
                            "url": "https://socket-manager.github.io/document/simple-socket/dev-ops.html",
                            "name": "SimpleSocketのDevOps環境"
                        },
                        {
                            "@type": "ListItem",
                            "position": 7,
                            "url": "https://socket-manager.github.io/document/simple-socket/generator.html",
                            "name": "SimpleSocketGeneratorクラス"
                        },
                        {
                            "@type": "ListItem",
                            "position": 8,
                            "url": "https://socket-manager.github.io/document/simple-socket/i-tcp-server.html",
                            "name": "ISimpleSocketTcpServerインターフェース"
                        },
                        {
                            "@type": "ListItem",
                            "position": 9,
                            "url": "https://socket-manager.github.io/document/simple-socket/i-tcp-client.html",
                            "name": "ISimpleSocketTcpClientインターフェース"
                        },
                        {
                            "@type": "ListItem",
                            "position": 10,
                            "url": "https://socket-manager.github.io/document/simple-socket/i-udp.html",
                            "name": "ISimpleSocketUdpインターフェース"
                        },
                        {
                            "@type": "ListItem",
                            "position": 11,
                            "url": "https://socket-manager.github.io/document/simple-socket/example.html",
                            "name": "実装例（UDP 通信）"
                        }
                    ]
                }
            ]
        }
        </script>
    </head>
    <body>
        <div class="layout">
            <div class="menu" role="navigation" aria-label="ページメニュー">
                <h2 class="menu-title">SOCKET-MANAGER</h2>
                <h4 class="menu-reference menu-page-title-bottom"><a href="../" target="_blank">&gt;&gt; Framework Top</a></h4>
                <h2 class="menu-label">MAIN-MENU</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./">▶シンプルソケット機能の概要</a></h3>

                </div>
                <h3 class="menu-label-sub">IMPLEMENT</h3>
                <div class="menu-text">

                    <h3 class="menu-page-title">▼TCP サーバーの実装</h3>

                    <ul>
                        <li><a href="./tcp-server.html#begin">はじめに</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#identifier">サーバー識別子</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#description">コマンド説明文</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#setting">設定可能項目</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#log-writer">ログライターの登録</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#set-unit-parameter">SocketManager との連携</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#keep-running">常時実行コールバックの登録</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#generate">コアインスタンスの生成</a></li>
                    </ul>
                    <ul>
                        <li><a href="./tcp-server.html#last">おわりに</a></li>
                    </ul>

                    <h3 class="menu-page-title-link"><a href="./tcp-client.html">▶TCP クライアントの実装</a></h3>

                    <h3 class="menu-page-title-link"><a href="./udp.html">▶UDP 通信の実装</a></h3>

                </div>
                <h3 class="menu-label-sub">PROJECT</h3>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./new-project.html">▶新規開発環境</a></h3>

                    <h3 class="menu-page-title-link"><a href="./dev-ops.html">▶DevOps環境</a></h3>

                </div>
                <h3 class="menu-label-sub">REFERENCE</h3>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./generator.html">▶SimpleSocketGenerator</a></h3>

                    <h3 class="menu-page-title-link"><a href="./i-tcp-server.html">▶ISimpleSocketTcpServer</a></h3>

                    <h3 class="menu-page-title-link"><a href="./i-tcp-client.html">▶ISimpleSocketTcpClient</a></h3>

                    <h3 class="menu-page-title-link"><a href="./i-udp.html">▶ISimpleSocketUdp</a></h3>

                </div>
                <h3 class="menu-label-sub">EXAMPLE</h3>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./example.html">▶実装例（UDP 通信）</a></h3>

                </div>
                <h2 class="menu-label">ADVANCED</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="../laravel.html" target="_blank">▶Laravelと連携する</a></h3>

                    <h3 class="menu-page-title-link"><a href="../system-setting.html" target="_blank">▶システム設定ファイル</a></h3>

                </div>
                <div class="menu-dummy-for-simple"></div>
            </div>
            <div class="main" role="main">

                <h1>【TCP サーバーの実装】</h1>

                <a id="begin"></a>
                <h2 class="subtitle">はじめに</h2>
                <div class="text-block">
                    本記事では、SOCKET‑MANAGER Framework の SimpleSocket 機能を使った TCP サーバーの実装手順を分かりやすく解説します。<br />
                    ジェネレータ（<code>SimpleSocketGenerator</code>）の初期設定、ノンブロッキングループの運用、ログ／UNIT連携、常時実行コールバックの実装例まで、実運用を見据えたコード例と運用ポイントを掲載します。<br /><br />

                    ここでは専用のコマンドを使ってスキャフォールディング可能な TCP サーバーをメイン処理クラスとして実装する方法をご紹介します。<br />
                    メイン処理クラスはアプリケーションのエントリポイントとして機能し、TCP サーバーのインスタンスはジェネレータクラスで生成されます。<br />
                    また、CLI上で表示されるアプリケーション識別子や説明文、さらにコマンドライン引数も含めたメイン処理クラス上でのカスタマイズできる内容を中心にご紹介します。<br /><br />

                    メイン処理クラスを生成するコマンドは以下の通り。<br />

                    <pre color-change="command" aria-label="コマンド実行（MainForTestというクラス名を指定する場合）">
> php worker simple:tcp-server MainForTest

[success] TCPサーバーのメイン処理クラス生成に成功しました (MainForTest)
                    </pre><br />
                    生成されたクラスは<code>app/MainClass</code>の場所に<code>MainForTest.php</code>というファイル名で格納されます。<br />

                    新しいメイン処理クラスが増えるとUsageの<code>main</code>カテゴリに項目が追加されます。<br />
                    <pre color-change="command" aria-label="Usageの表示">
> php worker

SOCKET-MANAGER Framework 1.X.X

Usage:
  command [arguments]

 main
  app:main-for-test                              Command description
 craft
  craft:init <初期化クラス名>                     初期化クラスの生成
  craft:parameter &lt;UNITパラメータクラス名&gt;        UNITパラメータクラスの生成
  craft:protocol <プロトコルUNIT定義のクラス名>   プロトコルUNIT定義のクラスとステータス名Enumの生成
  craft:command <コマンドUNIT定義のクラス名>      コマンドUNIT定義のクラスとキュー／ステータス名Enumの生成
  craft:main <メイン処理のクラス名>               メイン処理クラスの生成
  craft:setting <設定ファイル名>                  設定ファイルの生成
  craft:locale <メッセージファイル名>             メッセージファイルの生成
 runtime
  runtime:init <初期化クラス名>                   初期化クラスの生成
  runtime:parameter &lt;UNITパラメータクラス名&gt;      UNITパラメータクラスの生成
  runtime:units <ランタイムUNIT定義のクラス名>    ランタイムUNIT定義のクラスとキュー／ステータス名Enumの生成
  runtime:main <メイン処理のクラス名>             メイン処理クラスの生成
 simple
  simple:tcp-server <メイン処理のクラス名>        TCPサーバー用メイン処理クラスの生成
  simple:tcp-client <メイン処理のクラス名>        TCPクライアント用メイン処理クラスの生成
  simple:udp <メイン処理のクラス名>               UDP通信用メイン処理クラスの生成
                    </pre><br />

                    上記Usageのように<code>main</code>カテゴリに<code>app:main-for-test</code>という名前で追加されているのが確認できます。<br />
                </div><br />

                <a id="identifier"></a>
                <h2 class="subtitle">サーバー識別子</h2>
                <div class="text-block">
                    メイン処理クラスが生成されると以下のプロパティが確認できます。<br />
                    <pre color-change="php" aria-label="プロパティのメンバ">
/**
 * @var string $identifer アプリケーション識別子
 */
protected string $identifer = 'app:main-for-test {port_no?}';
                    </pre><br />

                    ここではコマンドラインフォーマットを定義しています。<br />
                    <code>app:main-for-test</code>の部分がサーバーアプリケーション（プロセス）名で、<code>{port_no?}</code>の部分がコマンドパラメータ名であり、デフォルトで定義される内容です。<br />
                    そしてサーバーアプリケーション名や、コマンドパラメータは自由にカスタマイズできます。<br /><br />

                    例えばコマンドパラメータにホスト名を追加したい場合は以下のようにします。<br />
                    <pre color-change="php" aria-label="ホスト名のパラメータを追加">
/**
 * @var string $identifer アプリケーション識別子
 */
protected string $identifer = 'app:main-for-test <font class="pre-yellow">{host_name}</font> {port_no?}';
                    </pre><br />

                    <code>port_no</code>の後ろに付いている"はてな（?）マーク"は省略可能である事を表しています。<br />
                    ちなみに"はてな（?）マーク"は最後尾の連続したパラメータにしか指定できません。<br />
                    例えば<code>{host_name?} {port_no?}</code>と書く事はできますが<code>{host_name?} {port_no}</code>と書く事はできません。<br /><br />

                    なお、メイン処理クラス内では<code>$this->getParameter('port_no')</code>のように書く事でパラメータを取得できます。<br />
                    省略可能なパラメータが省略されている時はnullが返却されます。<br />
                </div><br />

                <a id="description"></a>
                <h2 class="subtitle">コマンド説明文</h2>
                <div class="text-block">
                    メイン処理クラスが生成されると以下のプロパティが確認できます。<br />
                    <pre color-change="php" aria-label="プロパティのメンバ">
/**
 * @var string $description コマンド説明
 */
protected string $description = 'Command description';
                    </pre><br />

                    ここではUsageを表示した時のサーバーコマンドの説明文を定義しています。<br />
                    初期状態では<code>Command description</code>となっているので、これをプロパティで変更できます。<br />
                    例えば以下のように変更すると<br />

                    <pre color-change="php" aria-label="説明文の変更">
/**
 * @var string $description コマンド説明
 */
protected string $description = 'テスト用のサーバー';
                    </pre><br />

                    Usageでは以下のように表示されます。<br />
                    <pre color-change="command" aria-label="Usageの表示">
> php worker
SOCKET-MANAGER Framework 1.X.X

Usage:
  command [arguments]

 main
  app:main-for-test                              テスト用のサーバー
 craft
  craft:init <初期化クラス名>                     初期化クラスの生成
  craft:parameter &lt;UNITパラメータクラス名&gt;        UNITパラメータクラスの生成
  craft:protocol <プロトコルUNIT定義のクラス名>   プロトコルUNIT定義のクラスとステータス名Enumの生成
  craft:command <コマンドUNIT定義のクラス名>      コマンドUNIT定義のクラスとキュー／ステータス名Enumの生成
  craft:main <メイン処理のクラス名>               メイン処理クラスの生成
  craft:setting <設定ファイル名>                  設定ファイルの生成
  craft:locale <メッセージファイル名>             メッセージファイルの生成
 runtime
  runtime:init <初期化クラス名>                   初期化クラスの生成
  runtime:parameter &lt;UNITパラメータクラス名&gt;      UNITパラメータクラスの生成
  runtime:units <ランタイムUNIT定義のクラス名>    ランタイムUNIT定義のクラスとキュー／ステータス名Enumの生成
  runtime:main <メイン処理のクラス名>             メイン処理クラスの生成
 simple
  simple:tcp-server <メイン処理のクラス名>        TCPサーバー用メイン処理クラスの生成
  simple:tcp-client <メイン処理のクラス名>        TCPクライアント用メイン処理クラスの生成
  simple:udp <メイン処理のクラス名>               UDP通信用メイン処理クラスの生成
                    </pre><br />
                </div><br />

                <a id="setting"></a>
                <h2 class="subtitle">設定可能項目</h2>
                <div class="text-block">
                    このメイン処理クラスであらかじめ設定可能な項目は、<code>SimpleSocketGenerator</code> クラスのコンストラクタ引数です。<br />
                    各引数の設定方法には以下の３種類があります。<br />
                    <dl>
                        <dt>①メイン処理クラス内で直接指定</dt>
                        <dd>この項目でご紹介する方法です。</dd>
                        <dt>②コマンドラインから取得</dt>
                        <dd>上記の<font><a href="./tcp-server.html#identifier">&gt;&gt; サーバー識別子</a></font>の項目でご紹介した方法です。</dd>
                        <dt>③設定ファイル</dt>
                        <dd><font><a href="../setting.html" target="_blank">▶設定ファイル</a></font>のページでご紹介している方法です。</dd>
                    </dl>

                    <br />
                    <h3 class="underline">SimpleSocketGeneratorクラスの引数</h3>

                    メイン処理クラスの実行（exec）メソッドの冒頭部分には SimpleSocketGenerator クラスのインスタンス生成部分である以下のコードが含まれています。<br />

                    <pre color-change="php" aria-label="実行処理の冒頭部分">
public function exec()
{
    // 引数の取得
    $port_no = $this->getParameter('port_no');

    /***********************************************************************
     * シンプルソケットジェネレータの初期設定
     * 
     * ジェネレータインスタンスの生成や各種設定をここで実行します
     **********************************************************************/
    $generator = new SimpleSocketGenerator(SimpleSocketTypeEnum::TCP_SERVER, 'localhost', $port_no);

    ・
    ・
    ・
}
                    </pre><br />

                    この SimpleSocketGenerator クラスの引数の内訳は次の通りです。<br />

                    <ol>
                        <li>シンプルソケットタイプ（今回の場合は SimpleSocketTypeEnum.TCP_SERVER）</li>
                        <li>ホスト名（デフォルト：127.0.0.1）</li>
                        <li>ポート番号（デフォルト：15000）</li>
                        <li>ダウンタイム（デフォルト：100ms）</li>
                        <li>送受信バッファサイズ（デフォルト：255）</li>
                        <li>バッファスタック件数（デフォルト：1）</li>
                        <li>言語コード（デフォルト：'ja'）</li>
                        <li>接続制限数（デフォルト：10）</li>
                    </ol>

                    シンプルソケットタイプを除くこれら６つの項目をデフォルト値で指定すると以下のようになります。<br />

                    <pre color-change="php" aria-label="直接引数へ値を指定するパターン">
$generator = new SimpleSocketGenerator( SimpleSocketTypeEnum::TCP_SERVER, '127.0.0.1', 15000, 100, 255, 1, 'ja', 10 );
                    </pre><br />

                    <pre color-change="php" aria-label="引数指定を省略する事によるデフォルト値の適用">
$generator = new SimpleSocketGenerator( SimpleSocketTypeEnum::TCP_SERVER );
                    </pre><br />

                    <pre color-change="php" aria-label="null指定によるデフォルト値の適用">
$generator = new SimpleSocketGenerator( SimpleSocketTypeEnum::TCP_SERVER, null, null, null, null, null, null, null );
                    </pre><br />

                    御覧の通り、直接値を指定する事もできますが、引数を省略したり、nullを指定する事で自動的にデフォルト値が適用される仕組みになっています。<br />

                    <br />
                    <h3 class="underline">cycleDrivenメソッドの引数</h3>

                    メイン処理クラスの実行（exec）メソッド末尾のソースにはノンブロッキングループ内で<code>cycleDriven</code>メソッドが呼ばれている箇所があります。<br />

                    <pre color-change="php" aria-label="実行処理の末尾部分">
public function exec()
{
    ・
    ・
    ・

    // ノンブロッキングループ
    while(true)
    {
        // 周期ドリブン
        $ret = $generator->cycleDriven();
        if($ret === false)
        {
            goto finish;
        }
    }

    ・
    ・
    ・
}
                    </pre><br />

                    この<code>cycleDriven</code>メソッドの引数の内訳は次の通りです。<br />

                    <ol>
                        <li>周期インターバルタイム（デフォルト：2000μs）</li>
                    </ol>

                    この項目をデフォルト値で指定すると以下のようになります。<br />

                    <pre color-change="php" aria-label="直接引数へ値を指定するパターン">
$generator->cycleDriven( 2000 );
                    </pre><br />

                    <pre color-change="php" aria-label="引数指定を省略する事によるデフォルト値の適用">
$generator->cycleDriven();
                    </pre><br />

                    御覧の通り、直接値を指定する事もできますが、引数を省略しても自動的にデフォルト値が適用される仕組みになっています。<br />
                    なお、ここでは SimpleSocketGenerator クラスの引数のようにnullを指定する事はできません。<br /><br />
                </div><br />

                <a id="log-writer"></a>
                <h2 class="subtitle">ログライターの登録</h2>
                <div class="text-block">
                    メイン処理クラスの実行（exec）メソッドの中ほどに以下の定義があります。<br />

                    <pre color-change="php" aria-label="ログライター定義部分">
public function exec()
{
    ・
    ・
    ・

    /**
     * ログライターの登録（任意）
     * 
     * ログライターが使いたい場合に$generator->setLogWriter()メソッドで登録します
     * SocketManager初期化クラスのログライターをそのままお使い頂けます
     */
    $generator->setLogWriter
    (
        /**
         * ログライター
         * 
         * @param string $p_level ログレベル（debug、info、notice、warning、errorなど）
         * @param array $p_param 連想配列形式のログ内容
         * @return void
         */
        function(string $p_level, array $p_param): void
        {
        }
    );

    ・
    ・
    ・
}
                    </pre><br />

                    function 内に処理を定義する事もできますが、SocketManager などであらかじめ作成しておいた初期化クラスを使って登録する事もできます。<br />

                    <pre color-change="php" aria-label="SocketManager の初期化クラスによる登録">
public function exec()
{
    ・
    ・
    ・

    // 初期化クラスのインスタンスを生成
    $init = new InitForTest();

    ・
    ・
    ・

    /**
     * ログライターの登録（任意）
     * 
     * ログライターが使いたい場合に$generator->setLogWriter()メソッドで登録します
     * SocketManager初期化クラスのログライターをそのままお使い頂けます
     */
    $generator->setLogWriter( $init->getLogWriter() );

    ・
    ・
    ・
}
                    </pre><br />

                </div><br />

                <a id="set-unit-parameter"></a>
                <h2 class="subtitle">SocketManager との連携</h2>
                <div class="text-block">
                    メイン処理クラスの実行（exec）メソッドの中ほどに以下のコメント部分があります。<br />

                    <pre color-change="php" aria-label="setUnitParameter メソッドの定義部分">
public function exec()
{
    ・
    ・
    ・

    /**
     * SocketManagerとの連携（任意）
     * 
     * UNITパラメータインスタンスの"simple_socket"プロパティにシンプルソケットインスタンスが設定され
     * コマンドディスパッチャーやステータスUNIT内で使えるようになります
     * 
     * $generator->setUnitParameter()メソッドでUNITパラメータクラスを設定します
     */

    ・
    ・
    ・
}
                    </pre><br />

                    あらかじめ作成しておいたSocketManagerなどの UNIT パラメータクラスのインスタンスを、ここで以下のように引き渡して UNIT 処理と連携できます。

                    <pre color-change="php" aria-label="UNIT パラメータとの連携">
public function exec()
{
    ・
    ・
    ・

    // UNITパラメータのインスタンスを生成
    $param = new ParameterForTest();

    ・
    ・
    ・

    /**
     * SocketManagerとの連携（任意）
     * 
     * UNITパラメータインスタンスの"simple_socket"プロパティにシンプルソケットインスタンスが設定され  
     * コマンドディスパッチャーやステータスUNIT内で使えるようになります
     */ 
    $generator->setUnitParameter( $param );

    ・
    ・
    ・
}
                    </pre><br />

                    ここで設定した UNIT パラメータインスタンスを使って、UNIT 処理やコマンドディスパッチャーで利用できるようになります。<br />
                </div><br />

                <a id="keep-running"></a>
                <h2 class="subtitle">常時実行コールバックの登録</h2>
                <div class="text-block">
                    メイン処理クラスの実行（exec）メソッドの中ほどに以下の定義があります。<br />

                    <pre color-change="php" aria-label="常時実行処理定義部分">
public function exec()
{
    ・
    ・
    ・

    /**
     * 常時実行処理の登録（任意）
     * 
     * 常時実行処理がある場合に$generator->setKeepRunning()メソッドで登録します
     */
    $generator->setKeepRunning
    (
        /**
         * 常時実行処理
         * 
         * @param ISimpleSocketTcpServer $p_simple_socket シンプルソケットインスタンス
         * @param mixed[] $p_argv 可変引数（setKeepRunningメソッドの第二引数以降のものが渡される）
         * @return void
         */
        function(ISimpleSocketTcpServer $p_simple_socket): void
        {
        }
    );

    ・
    ・
    ・
}
                    </pre><br />

                    以下のように function 内に処理を定義する事もできますが、ヘルパー関数などの関数名を指定する事もできます。<br />

                    <pre color-change="php" aria-label="常時実行処理の実装">
public function exec()
{
    ・
    ・
    ・

    /**
     * 常時実行処理の登録（任意）
     * 
     * 常時実行処理がある場合に$generator->setKeepRunning()メソッドで登録します
     */
    $generator->setKeepRunning
    (
        /**
         * 常時実行処理
         * 
         * @param ISimpleSocketTcpServer $p_simple_socket シンプルソケットインスタンス
         * @param mixed[] $p_argv 可変引数（setKeepRunningメソッドの第二引数以降のものが渡される）
         * @return void
         */
        function(ISimpleSocketTcpServer $p_simple_socket): void
        {
            // データ受信
            $cid = null;
            $data = $p_simple_socket->recv($cid);

            // データのログ出力
            $p_simple_socket->logWriter('debug', ['受信データ' => $data]);

            // データ送信
            $p_simple_socket->send($cid, $data);
        }
    );

    ・
    ・
    ・
}
                    </pre><br />

                </div><br />

                <a id="generate"></a>
                <h2 class="subtitle">コアインスタンスの生成</h2>
                <div class="text-block">
                    メイン処理クラスの実行（exec）メソッドの中ほどに以下の定義があります。<br />

                    <pre color-change="php" aria-label="コアインスタンス生成部分">
public function exec()
{
    ・
    ・
    ・

    /**
     * シンプルソケットインスタンスの生成
     * 
     * この手続きが行われた時点でインスタンスが生成され有効になります
     */
    $w_ret = $generator->generate();
    if($w_ret === null)
    {
        goto finish;
    }

    ・
    ・
    ・
}
                    </pre><br />

                    シンプルソケットの各インターフェース用コアインスタンスが、ここで初めて生成されると同時に有効になります。<br />
                    generate メソッド実行時の戻り値（ここでは <code>$w_ret</code> 変数）には、setKeepRunning メソッドで設定するクロージャ、または関数の引数で渡される ISimpleSocketTcpServer インターフェースと同じものが設定されます（インスタンスの使い方は同じです）。<br /><br />

                    例えば初回起動時にログ出力する場合、以下のように書く事ができます。<br />
                    <pre color-change="php" aria-label="初回起動時のログ出力">
$interface = $generator->generate();
if($interface === null)
{
    goto finish;
}
$interface->logWriter('debug', ['TCPサーバー' => 'STARTUP']);
                    </pre><br />
                </div><br />

                <a id="last"></a>
                <h2 class="subtitle">おわりに</h2>
                <div class="text-block">
                    これまで見てきたように、メイン処理クラスではコマンドライン／設定項目／ログライター／SocketManager連携／常時実行コールバックを自由にデザインすることができます。<br />
                    シンプルソケット機能単体でも IPC（サーバー間通信）として機能しますが、SocketManager と連携させる事で IPC として利用する事もできます。<br />
                </div><br />
            </div>
        </div>
    </body>
</html>
