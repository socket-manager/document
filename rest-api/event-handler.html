<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>イベントハンドラ型実装 | REST-APIサーバー開発環境 | SOCKET-MANAGER Framework For PHP</title>
        <meta name="description" content="SOCKET-MANAGER Framework の REST-API 環境におけるイベントハンドラ型実装を解説。単一UNITによる即時処理、非同期レスポンス、Chunked・SSE・Range 送信などのストリーミング対応、スキャフォールディングで生成されるイベント処理クラスの構造、メイン処理クラスやルーティングとの連携方法を詳しく紹介します。" />
        <meta content="SOCKET-MANAGER, イベントハンドラ型, REST-API, PHP フレームワーク, UNIT, 非同期処理, Chunked Transfer, SSE, Server-Sent Events, Range Requests, スキャフォールディング, イベント処理クラス, メイン処理クラス, ルーティング, ストリーミングレスポンス" name="keywords" />
        <link rel="canonical" href="https://socket-manager.github.io/document/rest-api/event-handler.html" />

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF9W695NNW"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-LF9W695NNW');
        </script>
        <link rel="icon" href="https://socket-manager.github.io/document/favicon.ico" type="image/x-icon" />
        <link type="text/css" rel="stylesheet" href="../css/common.css" media="all" />
        <script src="../js/jquery-3.7.1.min.js"></script>
        <script type="text/javascript" src="../js/common.js"></script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "TechArticle",
            "headline": "REST-APIサーバー開発環境 - イベントハンドラ型実装",
            "description": "SOCKET-MANAGER Framework の REST-API 環境におけるイベントハンドラ型実装を解説。単一UNITによる即時処理、非同期レスポンス、Chunked・SSE・Range 送信などのストリーミング対応、スキャフォールディングで生成されるイベント処理クラスの構造、メイン処理クラスやルーティングとの連携方法を詳しく紹介します。",
            "keywords": "SOCKET-MANAGER, イベントハンドラ型, REST-API, PHP フレームワーク, UNIT, 非同期処理, Chunked Transfer, SSE, Server-Sent Events, Range Requests, スキャフォールディング, イベント処理クラス, メイン処理クラス, ルーティング, ストリーミングレスポンス",
            "inLanguage": "ja",
            "articleSection": [
                "Overview of Event Handler Implementation",
                "Scaffolding",
                "Generated Class Structure",
                "Basic Response Handling",
                "Chunked and SSE Streaming",
                "Range Response Handling",
                "Integration with REST-API Routing and Main Classes"
            ],
            "author": {
                "@type": "Person",
                "name": "SOCKET-MANAGER開発チーム"
            },
            "publisher": {
                "@type": "Organization",
                "name": "SOCKET-MANAGER",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://socket-manager.github.io/document/logo.png",
                    "width": 355,
                    "height": 50
                }
            },
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://socket-manager.github.io/document/rest-api/event-handler.html"
            },
            "url": "https://socket-manager.github.io/document/rest-api/event-handler.html",
            "breadcrumb": {
                "@type": "BreadcrumbList",
                "itemListElement": [
                    {
                        "@type": "ListItem",
                        "position": 1,
                        "name": "Framework Top",
                        "item": "https://socket-manager.github.io/document/"
                    },
                    {
                        "@type": "ListItem",
                        "position": 2,
                        "name": "REST-APIサーバー開発環境",
                        "item": "https://socket-manager.github.io/document/rest-api/"
                    },
                    {
                        "@type": "ListItem",
                        "position": 3,
                        "name": "イベントハンドラ型実装",
                        "item": "https://socket-manager.github.io/document/rest-api/event-handler.html"
                    }
                ]
            },
            "isPartOf": {
                "@type": "WebPage",
                "name": "REST-APIサーバー開発環境",
                "url": "https://socket-manager.github.io/document/rest-api/"
            }
        }
        </script>
    </head>

    <body>
        <div class="layout">
            <div class="menu" role="navigation" aria-label="ページメニュー">

                <h2 class="menu-title">SOCKET-MANAGER</h2>
                <h4 class="menu-reference menu-page-title-bottom">
                    <a href="../" target="_blank">&gt;&gt; Framework Top</a>
                </h4>

                <h2 class="menu-label">MAIN-MENU</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./">▶REST-APIサーバー開発環境</a></h3>

                    <h3 class="menu-label-sub">BASIC-CONCEPTS</h3>
                    <div class="menu-text">
                        <h3 class="menu-page-title-link"><a href="./concept.html">▶コンセプトと構造</a></h3>
                        <h3 class="menu-page-title-link"><a href="./install.html">▶導入と構成</a></h3>
                    </div>

                    <h3 class="menu-label-sub">QUICK-START</h3>
                    <div class="menu-text">
                        <h3 class="menu-page-title-link"><a href="./quickstart-sample.html">▶サンプルを利用する場合</a></h3>
                        <h3 class="menu-page-title-link"><a href="./quickstart-new-server.html">▶新規でサーバーを作る場合</a></h3>
                    </div>

                    <h3 class="menu-label-sub">CUEI-FOUNDATION</h3>
                    <div class="menu-text">
                        <h3 class="menu-page-title-link"><a href="./cuei.html">▶CUEIとの実装レベルでの関係</a></h3>
                        <h3 class="menu-page-title-link"><a href="./psr7.html">▶PSR-7 ラッパーの仕様</a></h3>
                        <h3 class="menu-page-title-link"><a href="./routing.html">▶ルーティングの概要</a></h3>
                    </div>

                    <h3 class="menu-label-sub">IMPLEMENT-STYLES</h3>
                    <div class="menu-text">

                        <h3 class="menu-page-title">
                            ▼イベントハンドラ型実装
                        </h3>

                        <ul>
                            <li><a href="./event-handler.html#begin">はじめに</a></li>
                        </ul>
                        <ul>
                            <li><a href="./event-handler.html#role">イベントハンドラ型の役割</a></li>
                        </ul>
                        <ul>
                            <li><a href="./event-handler.html#scaffold">スキャフォールディング</a></li>
                        </ul>
                        <ul>
                            <li><a href="./event-handler.html#structure">生成されるクラスの構造</a></li>
                        </ul>
                        <ul>
                            <li><a href="./event-handler.html#response">レスポンス操作の基本</a></li>
                        </ul>
                        <ul>
                            <li><a href="./event-handler.html#stream">チャンク転送・SSE の利用</a></li>
                        </ul>
                        <ul>
                            <li><a href="./event-handler.html#range">Range送信の実装例</a></li>
                        </ul>
                        <ul>
                            <li><a href="./event-handler.html#last">おわりに</a></li>
                        </ul>

                        <h3 class="menu-page-title-link"><a href="./state-machine.html">▶ステートマシン型実装</a></h3>
                    </div>

                    <h3 class="menu-label-sub">OTHER-CLASSES</h3>
                    <div class="menu-text">
                        <h3 class="menu-page-title-link"><a href="./main.html">▶メイン処理クラス実装</a></h3>
                        <h3 class="menu-page-title-link"><a href="./context.html">▶コンテキストクラス実装</a></h3>
                        <h3 class="menu-page-title-link"><a href="./parser.html">▶パーサークラス実装</a></h3>
                        <h3 class="menu-page-title-link"><a href="./parallel.html">▶Parallelクラス実装</a></h3>
                        <h3 class="menu-page-title-link"><a href="./scaffolding.html">▶スキャフォールディング</a></h3>
                    </div>

                    <h3 class="menu-label-sub">SETTING-FILES</h3>
                    <div class="menu-text">
                        <h3 class="menu-page-title-link"><a href="./setting-routing.html">▶ルーティング設定</a></h3>
                        <h3 class="menu-page-title-link"><a href="./setting-parameter.html">▶基本パラメータ設定</a></h3>
                        <h3 class="menu-page-title-link"><a href="./setting-cors.html">▶CORS 設定</a></h3>
                        <h3 class="menu-page-title-link"><a href="./setting-parser.html">▶パーサー設定</a></h3>
                    </div>

                    <h3 class="menu-label-sub">ADVANCED</h3>
                    <div class="menu-text">
                        <h3 class="menu-page-title-link"><a href="../custom-command.html" target="_blank">▶カスタムコマンド作成機能</a></h3>
                        <h3 class="menu-page-title-link"><a href="../laravel.html" target="_blank">▶Laravelと連携する</a></h3>
                        <h3 class="menu-page-title-link"><a href="../system-setting.html" target="_blank">▶システム設定ファイル</a></h3>
                    </div>

                </div>

                <div class="menu-dummy-for-rest-api"></div>
            </div>

            <div class="main" role="main">

                <h1>【イベントハンドラ型実装】</h1>

                <a id="begin"></a>
                <h2 class="subtitle">はじめに</h2>
                <div class="text-block">
                    このページでは、REST-API サーバー開発環境における<strong>イベントハンドラ型の実装方法</strong>について解説します。<br />
                    イベントハンドラ型は、受信したリクエストに対して<strong>単一の処理（UNIT）を即時実行する</strong>方式で、シンプルな API や軽量な処理に適しています。<br /><br />

                    イベントハンドラ型のイベント処理クラスはスキャフォールディングで自動生成できます。<br />
                    <font><a href="./scaffolding.html">▶スキャフォールディング</a></font><br /><br />

                    なお、生成されたイベント処理クラスは<strong>メイン処理クラスの <code>$classes['event']</code> にクラス名を設定することで適用されます</strong>。<br />
                    また、ルーティング定義の <code>event</code> キーには<strong>イベント処理クラス内のメソッド名</strong>を指定します。<br /><br />

                    UNIT の基本概念については、以下のページで詳しく解説しています。<br />
                    <font><a href="./event-handler.html" target="_blank">▶イベントハンドラについて</a></font>
                </div><br />

                <a id="role"></a>
                <h2 class="subtitle">イベントハンドラ型の役割</h2>
                <div class="text-block">
                    イベントハンドラ型のイベント処理クラスは、REST-API の処理において以下のような役割を持ちます。<br /><br />

                    <ul>
                        <li>単一の処理（UNIT）を即時実行する</li>
                        <li>軽量な API や単発レスポンスに適している</li>
                        <li>ステートマシン型よりもシンプルで実装コストが低い</li>
                        <li>ルーティングの event キーに対応するメソッドが直接呼び出される</li>
                    </ul>
                </div><br />

                <a id="scaffold"></a>
                <h2 class="subtitle">スキャフォールディング（生成方法）</h2>
                <div class="text-block">
                    イベントハンドラ型のイベント処理クラスは以下のコマンドで生成できます。<br />

                    <pre color-change="command" aria-label="イベントハンドラ型生成コマンド">
php worker custom:event-handler &lt;カスタム名&gt;
                    </pre><br />

                    生成されるファイル例：<br />
                    <pre aria-label="生成ファイル例">
app/EventClass/&lt;カスタム名&gt;.php
                    </pre><br />

                    生成されたクラスは<strong>メイン処理クラスの <code>$classes['event']</code> にクラス名を設定することで適用されます</strong>。<br />
                    ルーティング定義の <code>event</code> キーには、イベント処理クラス内の<strong>メソッド名</strong>を指定します。<br /><br />

                    カスタムコマンドの仕組みについては以下をご覧ください。<br />
                    <font><a href="../custom-command.html">▶カスタムコマンド作成機能</a></font>
                </div><br />

                <a id="structure"></a>
                <h2 class="subtitle">生成されるクラスの構造</h2>
                <div class="text-block">
                    スキャフォールディングで生成されるイベントハンドラクラスは以下のような構造になります。<br />

                    <pre color-change="php" aria-label="イベントハンドラ生成クラス例">
&lt;?php

namespace App\EventClass;

use App\CommandUnits\CommandForHandler;

class &lt;カスタム名&gt; extends CommandForHandler
{
    protected function responseJson($p_param)
    {
        $p_param->response()->json(['message' => 'Hello API']);
    }
}
                    </pre><br />

                    <h3 class="underline">● 特記事項</h3>
                    <ul>
                        <li>コマンドで指定した <strong>カスタム名</strong> がクラス名になる</li>
                        <li>生成先は <code>app/EventClass</code> 配下</li>
                        <li><code>CommandForHandler</code> を継承することでイベントハンドラ型として認識される</li>
                        <li>メイン処理クラスの <code>$classes['event']</code> にクラス名を設定する</li>
                        <li>ルーティングの <code>event</code> キーには<strong>メソッド名</strong>を設定する</li>
                    </ul>
                </div><br />

                <a id="response"></a>
                <h2 class="subtitle">レスポンス操作の基本</h2>
                <div class="text-block">

                    <br />
                    <h3 class="underline" style="margin-bottom: 0px;">● ステータスコードの設定</h3>
                    <pre color-change="php" aria-label="statusメソッド例">
$p_param->response()->status(404, 'Not Found');
                    </pre>
                    理由句は省略可能で、指定しない場合は自動で 200 OK になります。<br />

                    <br />
                    <h3 class="underline" style="margin-bottom: 0px;">● ヘッダの設定</h3>
                    <pre color-change="php" aria-label="headerメソッド例">
$p_param->response()->header('X-Sample', 'value');
                    </pre><br />

                    <h3 class="underline" style="margin-bottom: 0px;">● 単発レスポンス</h3>
                    <pre color-change="php" aria-label="textレスポンス例">
$p_param->response()->text('Hello');
                    </pre>

                    <pre color-change="php" aria-label="jsonレスポンス例">
$p_param->response()->json(['message' => 'OK']);
                    </pre>

                    <pre color-change="php" aria-label="fileレスポンス例">
$p_param->response()->file('./path/file.txt');
                    </pre>

                    <pre color-change="php" aria-label="downloadレスポンス例">
$p_param->response()->download('./path/file.txt');
                    </pre>
                </div><br />

                <a id="stream"></a>
                <h2 class="subtitle">チャンク転送・SSE の利用について</h2>
                <div class="text-block">
                    イベントハンドラ型実装では、以下のように <strong>チャンク転送（Chunked Transfer）</strong> や<strong>SSE（Server-Sent Events）</strong> を簡単に利用できます。<br />

                    <br />
                    <h3 class="underline" style="margin-bottom: 0px;">● チャンク転送の例</h3>
                    <pre color-change="php" aria-label="イベントハンドラ型でのチャンク転送例">
$p_param->response()->chunked("1行目のデータです\n");
$p_param->response()->chunked("2行目：少しずつ送信しています...\n");
$p_param->response()->chunked("3行目：もう少しお待ちください...\n");
$p_param->response()->chunked("4行目：最後のデータです\n");
$p_param->response()->end();
                    </pre><br />

                    <h3 class="underline" style="margin-bottom: 0px;">● SSE の例</h3>
                    <pre color-change="php" aria-label="イベントハンドラ型でのSSE例">
$p_param->response()->event("1回目のデータです", p_id: "sse0");
$p_param->response()->event("2回目：少しずつ送信しています...", p_id: "sse1");
$p_param->response()->event("3回目：まだ続きます...", p_id: "sse2");
$p_param->response()->event("done", p_event: "end");
$p_param->response()->end();
                    </pre><br />

                    上記のように、イベントハンドラ型でもストリーミングレスポンスを簡潔に記述できますが、<strong>イベントハンドラ型は 1 回のメソッド実行内でレスポンスをまとめて処理する方式</strong>のため、以下のようなケースが発生する可能性があります。<br /><br />

                    <ul>
                        <li>送信したデータがネットワーク層で部分的に結合されて届く</li>
                        <li>複数回に分けたつもりのデータが、クライアント側で一度に受信される</li>
                        <li>確実な分割送信（逐次ステップ実行）が保証されない</li>
                    </ul><br />

                    そのため、<strong>確実に段階的な送信を行いたい場合</strong>や、<strong>ステップごとに非同期処理・待機処理（setTimeout など）を挟みたい場合</strong>は、以下のように <strong>ステートマシン型（ステートマシン型）</strong> の利用を推奨します。<br /><br />

                    <font><a href="./state-machine.html">▶ステートマシン型実装</a></font><br /><br />

                    ステートマシン型では、UNIT ごとにステータスを分けて処理を実行するため、<strong>確実な分割送信・逐次処理・非同期遷移</strong>が保証されます。<br />
                    チャンク転送や SSE を厳密に制御したい場合は、ステートマシン型を選択してください。<br />
                </div><br />

                <a id="range"></a>
                <h2 class="subtitle">Range送信の実装例</h2>
                <div class="text-block">
                    Range送信では、バイナリデータやファイルデータの<strong>全量をそのまま渡すだけで</strong>、  
                    フレームワーク側が Range ヘッダの有無を自動判定し、必要な範囲の切り貼りを行ってレスポンスを返します。<br />
                    デベロッパーは Range 処理を意識する必要がなく、通常のレスポンスと同じ感覚で扱えます。<br /><br />

                    Range リクエストの標準仕様については、MDN の解説も参考になります。<br />
                    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests" target="_blank">
                        &gt;&gt; MDN: HTTP Range Requests
                    </a><br />

                    <br />
                    <h3 class="underline" style="margin-bottom: 0px;">● rangeBinary</h3>
                    <pre color-change="php" aria-label="rangeBinary例">
$p_param->response()->rangeBinary($binary_data);
                    </pre>

                    バイナリデータの全量を渡すだけで、Range 指定があればフレームワークが自動で切り出して返します。<br />

                    <br />
                    <h3 class="underline" style="margin-bottom: 0px;">● rangeFile</h3>
                    <pre color-change="php" aria-label="rangeFile例">
$p_param->response()->rangeFile('./path/file.txt');
                    </pre>

                    ファイルパスを渡すだけで、Range 指定に応じた部分送信をフレームワークが自動処理します。<br />
                </div><br />

                <a id="last"></a>
                <h2 class="subtitle">おわりに</h2>
                <div class="text-block">
                    イベントハンドラ型は、REST-API サーバー開発において<strong>軽量な処理・単発レスポンス</strong>を実装する際に最適な方式です。<br />
                    スキャフォールディングを活用することで、イベント処理クラスの作成を効率化できます。<br /><br />

                    生成可能なクラス一覧については以下をご覧ください。<br />
                    <font><a href="./scaffolding.html">▶スキャフォールディング</a></font>
                </div><br />

            </div>
        </div>
    </body>
</html>
