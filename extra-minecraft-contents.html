<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>マイクラコンテンツ用 | SOCKET-MANAGER Framework For PHP</title>
        <meta name="description" content="マインクラフト専用コンテンツを扱うプロジェクト環境についてご紹介します" />
        <meta content="bedrock,websocket,マインクラフト,統合版,minecraft" name="keywords">

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF9W695NNW"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-LF9W695NNW');
        </script>
        <link rel="icon" href="./favicon.ico" type="image/x-icon" />
        <link type="text/css" rel="stylesheet" href="././css/common.css" media="all" />
        <script src="././js/jquery-3.7.1.min.js"></script>
        <script type="text/javascript" src="././js/common.js"></script>
    </head>
    <body>
        <div class="layout">
            <div class="menu">
                <h2 class="menu-title">SOCKET-MANAGER</h2>
                <h4 class="menu-reference menu-page-title-link"><a href="./reference/index.html" target="blank">&gt;&gt; Reference</a></h4>
                <h2 class="menu-label">MAIN-MENU</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./index.html">▶フレームワークのご紹介</a></h3>

                    <h3 class="menu-page-title-link"><a href="./websocket.html">▶Websocket開発環境</a></h3>

                    <h3 class="menu-page-title-link"><a href="./new-project.html">▶新規プロジェクト開発環境</a></h3>

                    <h3 class="menu-page-title-link"><a href="./laravel.html">▶Laravelと連携する</a></h3>

                    <h3 class="menu-page-title-link"><a href="./architecture.html">▶アーキテクチャ</a></h3>

                    <h3 class="menu-page-title-link"><a href="./multi-server.html">▶マルチサーバーの構成</a></h3>

                    <h3 class="menu-page-title-link"><a href="./system-setting.html">▶システム設定ファイル</a></h3>

                </div>
                <h2 class="menu-label">EXTRA-MENU</h2>
                <div class="menu-text">

                    <h3 class="menu-page-title-link"><a href="./extra-demo.html">▶デモサーバーの種類</a></h3>

                    <h3 class="menu-page-title-link"><a href="./extra-demo-command.html">▶デモのコマンド仕様</a></h3>

                    <h3 class="menu-page-title-link"><a href="./extra-demo-setting.html">▶デモの設定ファイル</a></h3>

                    <h3 class="menu-page-title-link"><a href="./extra-minecraft.html">▶マインクラフトの通信仕様</a></h3>

                    <h3 class="menu-page-title-link"><a href="./extra-close-frame.html">▶切断フレームの検証</a></h3>

                    <h3 class="menu-page-title">▼マイクラコンテンツ用</h3>

                    <ul>
                        <li><a href="./extra-minecraft-contents.html#begin">はじめに</a></li>
                    </ul>
                    <ul>
                        <li><a href="./extra-minecraft-contents.html#project">プロジェクト環境</a></li>
                    </ul>
                    <ul>
                        <li><a href="./extra-minecraft-contents.html#contents">コンテンツ</a></li>
                    </ul>
                    <ul>
                        <li><a href="./extra-minecraft-contents.html#last">おわりに</a></li>
                    </ul>

                </div>
            </div>
            <div class="main">

                <h1>【マイクラコンテンツ用】</h1>

                <a id="begin"></a>
                <h2 class="subtitle">はじめに</h2>

                <div class="text-block">
                    ここではWebsocketサーバーを使った運用を前提としています。<br />
                    スコアボードやコマンドを駆使して四苦八苦しながらイベントを判定したりするのを避け、サーバープログラミングを使って極力運用の負担を減らそうというのが狙いです。<br />
                    基本的にはファミリー向けに楽しく遊べるものを目指しているので、グローバルコンテンツや商用利用は今のところ考えていません。<br /><br />

                    サーバーフレームワークのご紹介時に利用したデモ環境は、マインクラフト（統合版）を含めたWebsocket用チャットサーバーの実装例としてご紹介していましたが、ここではマインクラフト専用のコンテンツとしてプロジェクト環境を構築しているので別物だとお考えください。<br /><br />

                    ※この環境はデモ環境をベースに構築しているのでチャット機能も引き継いでいます。<br />
                </div><br />

                <a id="project"></a>
                <h2 class="subtitle">プロジェクト環境</h2>

                <div class="text-block">
                    マインクラフト用のプロジェクト環境は以下のコマンドでインストールできます。<br />
                    ※GitHubから直接ダウンロードする場合は<font><a href="https://github.com/socket-manager/contents-project" target="_blank">&gt;&gt; こちら</a></font>からどうぞ。<br />

                    <span>インストールコマンド</span>
                    <pre color-change="command">
> composer create-project socket-manager/contents-project <インストール先のディレクトリ名>
                    </pre><br />

                    インストール後のディレクトリ構成は以下のようになっています。<br />
                    <span>ディレクトリ構成</span>
                    <pre>
/app
    /client             Webブラウザ用クライアント
        /jquery         jQuery版
        /react          React版
    /behavior_packs     ビヘイビアパック（マインクラフト用）
    /InitClass          初期化クラス
    /UnitParameter      UNITパラメータクラス
    /ProtocolUnits      プロトコルUNIT定義クラス
    /CommandUnits       コマンドUNIT定義クラス
    /MainClass          メイン処理クラス
/logs                   ログ出力用
/setting                設定ファイル用
                    </pre><br />

                    Webブラウザ用クライアントディレクトリにはデモ環境と同じくjQuery版とReact版のHTMLファイル（chat.html）が入っていますのでお好きな方をブラウザにドラッグ＆ドロップしてお使いください。<br /><br />

                    専用アイテムを有効にするためにはマインクラフトワールドデータのルートテーブルを触る必要があります。<br />
                    今回使用しているルートテーブルの追加分をプロジェクト内の<code>app/behavior_packs</code>ディレクトリにビヘイビアパックとして同梱しています。<br />
                    このディレクトリの中身をそのまま統合版ゲームデータの<code>behavior_packs</code>ディレクトリにコピーしてお使いください。<br /><br />

                    ※オリジナルビヘイビアパックの作成方法や適用方法に関しては<font><a href="https://minecraft.fandom.com/ja/wiki/%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB/Bedrock_Edition/%E3%83%93%E3%83%98%E3%82%A4%E3%83%93%E3%82%A2%E3%83%BC%E3%83%91%E3%83%83%E3%82%AF%E3%81%AE%E4%BD%9C%E6%88%90" target="_blank">&gt;&gt; こちら</a></font>のサイトが参考になると思います。<br /><br />

                    サーバーの起動方法はデモ環境と全く同じです。<br />
                    例えばマインクラフト用のWebsocketサーバーを起ち上げる場合にはプロジェクトルートで以下のようにコマンドを実行すれば起動します。<br />

                    <span>サーバーの起動（10000ポートで起動する場合）</span>
                    <pre color-change="command">
&gt; php worker app:minecraft-chat-server 10000
                    </pre><br />

                    マインクラフトはUWPアプリのためlocalhost（127.0.0.1）で利用する場合は以下のコマンドを実行してループバックアドレスへのアクセスを許可しておく必要があります。<br />

                    <span>ループバックアドレス許可の設定</span>
                    <pre color-change="command">
> CheckNetIsolation.exe LoopbackExempt -a -n="Microsoft.MinecraftUWP_8wekyb3d8bbwe"
                    </pre><br />

                    マインクラフトから接続する時は以下の形式で入力します。<br />
                    
                    <span>マインクラフトからの接続（10000ポートに接続する場合）</span>
                    <pre color-change="command">
> /wsserver localhost:10000/<ユーザー名>
                    </pre><br />
                    
                    上記のユーザー名はマインクラフト内のユーザー名でなくても構いません。<br />
                    あくまでWebsocketサーバー内で使用する名前です。
                </div><br />

                <a id="contents"></a>
                <h2 class="subtitle">コンテンツ</h2>

                <div class="text-block">
                    本プロジェクト環境で実装しているコンテンツのご紹介です。<br /><br /><br />

                    <h3 class="underline">チャット機能</h3>

                    <br />
                    <dl>
                        <dt>■通常チャット</dt>
                        <dd>
                            <br />
                            機能はデモ環境と全く同じです。Webブラウザから送信されたコメントはマインクラフト上でタイトル表示されます。<br />
                            もちろんマインクラフトからのチャットもWebブラウザへ送信されます。
                        </dd><br />
                        <dt>■プライベートチャット</dt>
                        <dd>
                            <br />
                            機能はデモ環境と全く同じですが、Websocketサーバー接続中にマルチプレイでウィスパー機能を使うと何故かワールドオーナー経由で送信される仕様になっているようですので、他の人が送信してもワールドオーナーが送信した事にされてしまいます。ですのでマルチプレイ時のウィスパー機能の使用は極力お控えください。<br /><br />

                            また、Websocket上のプライベート送信機能（&lt;メッセージ>#<ユーザー名&gt;）をマルチプレイ時に使うとマインクラフトのチャット機能が働いて他のマインクラフトユーザーに見えてしまいますので、あくまでWebブラウザユーザーとの通信手段だとお考えください。
                        </dd>
                    </dl><br />
                    <br />
                    <img src="./img/extra-minecraft-contents/chat.gif" /><br /><br />
                    <br />
                    <br />

                    <h3 class="underline">いなずまの弓</h3>

                    <br />
                    以下のように矢を放った方向へ稲妻を落とせます。<br />
                    <img src="./img/extra-minecraft-contents/ground.gif" /><br /><br />

                    空を見上げるアングルではこんなイメージ<br />
                    <img src="./img/extra-minecraft-contents/sky_thunder.png" height="600px" width="728px" /><br /><br />

                    矢を放ったタイミングで稲妻を落とすので、近距離／遠距離の同時攻撃が可能なチート装備です。<br />
                    自分がダメージを受けないギリギリのところへ落とすようにしているのでサバイバルモードでも安心です。<br /><br />

                    地上だけではなく以下の場所でも使える事を確認しています。<br />

                    <ul>
                        <li>水中</li>
                        <li>洞窟</li>
                        <li>ネザー</li>
                        <li>エンド</li>
                    </ul>

                    何故か雲がないのにネザーやエンドでも使えるようです。<br /><br />

                    操作に慣れてくれば矢で牽制しながら稲妻を落とせるので帯電クリーパーやピグリンも量産し放題でしょう。<br /><br />

                    <h4>「いなずまの弓」の取得</h4>

                    ビヘイビアパックを適用しておけば、以下のコマンドでユニークアイテムとして「いなずまの弓」が手に入ります。<br />

                    <img src="./img/extra-minecraft-contents/drop.gif" /><br /><br />


                    <h4>サーバー側の実装</h4>

                    今回のアイテムの実装では"ItemUsed"というサブスクライブイベントを使用しています。<br/>
                    マインクラフト上でアイテムを使ったと認識されると発生するイベントのようで、フレームワークを使って以下の内容を実装しています。<br /><br />

                    ※サブスクライブイベントについては<font><a href="./extra-minecraft.html#send" target="_blank">&gt;&gt; こちら</a></font>でご紹介しています。<br />

                    <span>弓を使った時に発生するイベントデータの形式</span>
                    <pre>
{
    "body":
    {
        "count":<数字>,
        "item":
        {
            "aux":<数字>,
            "id":"bow",
            "namespace":<文字列>
        },
        "player":
        {
            "color":<16進数？>,
            "dimension":<数字>,
            "id":<数字>,
            "name":<文字列>,
            "position":
            {
                "x":<数字>,
                "y":<数字>,
                "z":<数字>
            },
            "type":<文字列>,
            "variant":<数字>,
            "yRot":<数字>
        },
        "useMethod":<数字>
    },
    "header":
    {
        "eventName":"ItemUsed",
        "messagePurpose":<文字列>,
        "version":<数字>
    }
}
                    </pre><br />

                    <h4>－ 以下の実装はフレームワークを使う上でのお決まりの書き方です －</h4>

                    <br />
                    イベントを処理するための任意のコマンド名を以下のファイルへ定義します。<br />
                    <span>app/CommandUnits/CommandQueueEnumForMinecraft.php</span>
                    <pre color-change="php">
case ITEM_USED = 'item_used';
                    </pre><br />

                    コマンド名を以下の場所へ追加して利用可能にします。<br />
                    <span>app/CommandUnits/CommandForMinecraft.php</span>
                    <pre color-change="php">
protected const QUEUE_LIST = [
    CommandQueueEnumForMinecraft::ITEM_USED->value
];
                    </pre><br />

                    コマンド名と処理（関数）の関係を以下のメソッドへ追加して紐づけを行います。<br />
                    <span>app/CommandUnits/CommandForMinecraft.php</span>
                    <pre color-change="php">
public function getUnitList(string $p_que): array
{
    $ret = [];
    ・
    ・
    ・
    if($p_que === CommandQueueEnumForMinecraft::ITEM_USED->value)
    {
        $ret[] = [
            'status' => CommandStatusEnumForMinecraft::START->value,
            'unit' => $this->getItemUsedStart()
        ];
    }

    return $ret;
}
                    </pre><br />

                    <h4>－ 以下の３点は今回の実装で特に重要な部分です －</h4>

                    サブスクライブイベントは以下の設定ファイルへ登録します（複数登録可）。<br />
                    これをいれておく事で、弓を使ったイベントを検知してマインクラフトがWebsocketサーバーへイベントデータを送信してくれます。<br />

                    <span>setting/minecraft.php</span>
                    <pre color-change="php">
return [
    'subscribe_types' =>
    [
        'ItemUsed'
    ]
];
                    </pre><br />

                    受信したイベントデータをコマンド名へ変換する処理を以下のコマンドディスパッチャーへ追加します。<br />
                    ※ここでは<code>bow</code>というアイテム名と共に<code>aux</code>の数字を判定していますが、この<code>aux</code>がないと全ての弓アイテム使用時に発動してしまいます。<br />
                    ※<code>aux</code>のデータ値はビヘイビアパックで定義しています。<br />
                    <span>app/InitClass/InitForMinecraft.php</span>
                    <pre color-change="php">
public function getCommandDispatcher()
{
    return function(ParameterForMinecraft $p_param, $p_dat): ?string
    {
        $minecraft = $p_param->isMinecraft();
        if($minecraft === true)
        {
            ・
            ・
            ・
            if(isset($p_dat['data']['header']['eventName']) && $p_dat['data']['header']['eventName'] === 'ItemUsed')
            {
                if($p_dat['data']['body']['item']['id'] === 'bow' && $p_dat['data']['body']['item']['aux'] === 401)
                {
                    return CommandQueueEnumForMinecraft::ITEM_USED->value;
                }
            }
            ・
            ・
            ・
        }
    }
}
                    </pre><br />

                    コマンド名に紐づけた処理（関数）を以下のファイルへ実装します。<br />
                    ※ここでは受信した座標データと三角関数を使って稲妻を落とす座標を計算した後マインクラフトへ<code>summon</code>コマンドを送信しています。<br />
                    <span>app/CommandUnits/CommandForMinecraft.php</span>
                    <pre color-change="php">
protected function getItemUsedStart()
{
    return function(ParameterForMinecraft $p_param): ?string
    {
        $p_param->logWriter('debug', ['MINECRAFT ITEM_USED:START' => 'START']);

        // 受信データの取得
        $rcv = $p_param->getRecvData();
        $x = (float)$rcv['data']['body']['player']['position']['x'];
        $y = (float)$rcv['data']['body']['player']['position']['y'];
        $x = (float)$rcv['data']['body']['player']['position']['z'];
        $y_rot = (float)$rcv['data']['body']['player']['yRot'];
        $y_rot_abs = abs($y_rot);

        // Z座標の計算
        $z = cos(deg2rad($y_rot_abs)) * 5;

        // X座標の計算
        $x = sin(deg2rad($y_rot_abs)) * 5;
        if($y_rot > 0)
        {
            $x = -$x;
        }

        // コマンド送信
        $cmd_data = $p_param->getCommandDataForThunderBow($x, 0, $z);
        $data =
        [
            'data' => $cmd_data
        ];
        $p_param->setSendStack($data);

        return null;
    };
}
                    </pre><br />

                    <h3 class="underline">いなずまの矢</h3>

                    <br />
                    以下のように矢を放った場所へ稲妻を落とせます。<br />
                    <img src="./img/extra-minecraft-contents/arrow.gif" /><br /><br />

                    <h4>「いなずまの矢」の取得</h4>

                    ビヘイビアパックを適用しておけば、以下のコマンドでユニークアイテムとして「いなずまの矢」が手に入ります。<br />

                    <img src="./img/extra-minecraft-contents/drop_arrow.gif" /><br /><br />

                    ちなみに先に作っていた「いなずまの弓」とコンボするとこんなイメージ。<br />
                    <img src="./img/extra-minecraft-contents/combo.gif" /><br /><br />

                    これで安全に帯電クリーパーやピグリンも量産し放題でしょう。<br /><br />


                    <h4>サーバー側の実装</h4>

                    「いなずまの弓」の時と同様に今回のアイテムの実装では"ItemUsed"というサブスクライブイベントを使用しています。<br/>
                    マインクラフト上でアイテムを使ったと認識されると発生するイベントのようで、フレームワークを使って以下の内容を実装しています。<br /><br />

                    ※サブスクライブイベントについては<font><a href="./extra-minecraft.html#send" target="_blank">&gt;&gt; こちら</a></font>でご紹介しています。<br />

                    <span>矢を放った時に発生するイベントデータの形式</span>
                    <pre>
{
    "body":
    {
        "count":<数字>,
        "item":
        {
            "aux":<数字>,
            "id":"arrow",
            "namespace":<文字列>
        },
        "player":
        {
            "color":<16進数？>,
            "dimension":<数字>,
            "id":<数字>,
            "name":<文字列>,
            "position":
            {
                "x":<数字>,
                "y":<数字>,
                "z":<数字>
            },
            "type":<文字列>,
            "variant":<数字>,
            "yRot":<数字>
        },
        "useMethod":<数字>
    },
    "header":
    {
        "eventName":"ItemUsed",
        "messagePurpose":<文字列>,
        "version":<数字>
    }
}
                    </pre><br />

                    今回の実装では「いなずまの弓」を作った時と処理フローが少し異なります。<br /><br />

                    <h4>【いなずまの弓の場合】</h4>

                    <dl>
                        <dt>(1)ItemUsedイベント（弓を使った時）の発生</dt>
                        <dt>(2)稲妻を落とす座標を計算してsummonコマンドを発行</dt>
                    </dl><br />

                    <h4>【いなずまの矢の場合】</h4>

                    <dl>
                        <dt>(1)ItemUsedイベント（弓を使った時）の発生</dt>
                        <dt>(2)放った矢にタグを発行</dt>
                        <dt>(3)ItemUsedイベント（矢を放った時）の発生</dt>
                        <dt>(4)放った矢の場所にsummonコマンドを発行</dt>
                    </dl><br />

                    上記の事から大きく分けて二つの大きな違いがあります。<br /><br />

                    まず一つ目はイベントが２回発行されるという事です。<br />
                    つまり「弓を使ったイベント」⇒「矢を放ったイベント」の順で２回発行されます。<br /><br />

                    そして二つ目の違いは放った矢にタグを付与しているところです。<br />
                    これはJava版でも同じでしたが弓で矢を放つと別のエンティティ（矢）としてスポーンしますので、「いなずまの矢」を放ったプレイヤーの矢（エンティティ）にタグを付与する事で特別な矢である事を認識させます。<br />
                    そして稲妻を落とす時（summonコマンド発行時）にターゲットセレクタでタグを指定するようにしています。<br />
                    これをしておかないと通常の矢を放った時でも発動してしまいます。<br /><br />

                    あと忘れてはいけないのはWebsocketサーバーからはexecuteコマンドを発行できないという事です。<br />
                    元々このコマンドはエンティティから実行されるように設計されているようなのでWebsocketサーバーはエンティティだと認識されていないからです。<br />
                    そのため今回はWebsocketサーバーからfunctionコマンドを発行する事で実際のコマンド処理をビヘイビアパックで賄うようにしています。<br /><br />

                    以上の事を踏まえて今回は以下のように実装しています。<br /><br />

                    <h4>－ 以下の実装はフレームワークを使う上でのお決まりの書き方です －</h4>

                    <br />
                    今回はイベントが２回発行される事から「いなずまの弓」実装時のコマンドをそのまま使うのでステータスUNITを追加します。<br />
                    まずは下記で今回用のステータス名を追加定義します。<br />
                    <span>app/CommandUnits/CommandStatusEnumForMinecraft.php</span>
                    <pre color-change="php">
case ARROW = 'arrow';
                    </pre><br />

                    コマンド名と処理（関数）の関係を以下のメソッドへ追加して紐づけを行います。<br />
                    ※以下の黄色の部分が今回追加したところです。<br />
                    <span>app/CommandUnits/CommandForMinecraft.php</span>
                    <pre color-change="php">
public function getUnitList(string $p_que): array
{
    $ret = [];
    ・
    ・
    ・
    if($p_que === CommandQueueEnumForMinecraft::ITEM_USED->value)
    {
        $ret[] = [
            'status' => CommandStatusEnumForMinecraft::START->value,
            'unit' => $this->getItemUsedStart()
        ];
<font class="pre-yellow">
        $ret[] = [
            'status' => CommandStatusEnumForMinecraft::ARROW->value,
            'unit' => $this->getItemUsedArrow()
        ];
</font>
    }

    return $ret;
}
                    </pre><br />

                    <h4>－ 以下の３点は今回の実装で特に重要な部分です －</h4>

                    受信したイベントデータをコマンド名へ変換する処理を以下のコマンドディスパッチャーへ追加します。<br />
                    ※ここでは<code>arrow</code>というアイテム名と共に<code>aux</code>の数字を判定していますが、この<code>aux</code>がないと全ての弓アイテム使用時に発動してしまいます。<br />
                    ※<code>aux</code>のデータ値はビヘイビアパックで定義しています。<br />
                    ※以下の黄色の部分が今回追加したところです。<br />
                    <span>app/InitClass/InitForMinecraft.php</span>
                    <pre color-change="php">
public function getCommandDispatcher()
{
    return function(ParameterForMinecraft $p_param, $p_dat): ?string
    {
        $minecraft = $p_param->isMinecraft();
        if($minecraft === true)
        {
            ・
            ・
            ・
            if(isset($p_dat['data']['header']['eventName']) && $p_dat['data']['header']['eventName'] === 'ItemUsed')
            {
                // 弓イベントの場合
                if($p_dat['data']['body']['item']['id'] === 'bow')
                {
                    return CommandQueueEnumForMinecraft::ITEM_USED->value;
                }

<font class="pre-yellow">
                // 矢イベントの場合
                if($p_dat['data']['body']['item']['id'] === 'arrow')
                {
                    return CommandQueueEnumForMinecraft::ITEM_USED->value;
                }
</font>
            }
            ・
            ・
            ・
        }
    }
}
                    </pre><br />

                    「いなずまの弓」を実装した時のUNIT処理を以下のように修正して、２回目の<code>ItemUsed</code>イベントに備えて<code>getItemUsedArrow</code>メソッドのUNITへ処理を繋ぎます。<br />
                    ※<code>getCommandDataForArrowTag</code>メソッドが矢にタグを付与するコマンド文字列を生成している所です。<br />
                    ※以下の黄色の部分が今回追加・修正したところです。<br />
                    <span>app/CommandUnits/CommandForMinecraft.php</span>
                    <pre color-change="php">
protected function getItemUsedStart()
{
    return function(ParameterForMinecraft $p_param): ?string
    {
        $p_param->logWriter('debug', ['MINECRAFT ITEM_USED:START' => 'START']);

        // 受信データの取得
        $rcv = $p_param->getRecvData();

<font class="pre-yellow">
        // ディスパッチャー強制
        $p_param->setForcedDispatcher(true);

        // コマンド送信
        $cmd_data = $p_param->getCommandDataForArrowTag($rcv['data']['body']['player']['name']);
        $data =
        [
            'data' => $cmd_data
        ];
        $p_param->setSendStack($data);

        if($rcv['data']['body']['item']['aux'] !== 401)
        {
            return CommandStatusEnumForMinecraft::ARROW->value;
        }
</font>

        $x = (float)$rcv['data']['body']['player']['position']['x'];
        $y = (float)$rcv['data']['body']['player']['position']['y'];
        $x = (float)$rcv['data']['body']['player']['position']['z'];
        $y_rot = (float)$rcv['data']['body']['player']['yRot'];
        $y_rot_abs = abs($y_rot);

        // Z座標の計算
        $z = cos(deg2rad($y_rot_abs)) * 5;

        // X座標の計算
        $x = sin(deg2rad($y_rot_abs)) * 5;
        if($y_rot > 0)
        {
            $x = -$x;
        }

        // コマンド送信
        $cmd_data = $p_param->getCommandDataForThunderBow($x, 0, $z);
        $data =
        [
            'data' => $cmd_data
        ];
        $p_param->setSendStack($data);

<font class="pre-yellow">
        return CommandStatusEnumForMinecraft::ARROW->value;
</font>
    };
}
                    </pre><br />

                    <code>CommandStatusEnumForMinecraft::ARROW</code>ステータス名に紐づけた処理（関数）を以下のファイルへ実装します。<br />
                    ※ここでは２つ目の<code>ItemUsed</code>イベントを受信（aux=411）した時にマインクラフトへ<code>function</code>コマンドを送信（getCommandDataForThunderArrowメソッドでコマンド文字列を生成）しています。<br />
                    <span>app/CommandUnits/CommandForMinecraft.php</span>
                    <pre color-change="php">
protected function getItemUsedArrow()
{
    return function(ParameterForMinecraft $p_param): ?string
    {
        $p_param->logWriter('debug', ['MINECRAFT ITEM_USED:ARROW' => 'START']);

        $sta = $p_param->getStatusName();

        // 受信データの取得
        $rcv = $p_param->getRecvData();
        if($rcv === null)
        {
            // ディスパッチャー強制
            $p_param->setForcedDispatcher(true);
            return $sta;
        }

        if($rcv['data']['body']['item']['aux'] === 411)
        {
            // コマンド送信（いなずまの矢）
            $cmd_data = $p_param->getCommandDataForThunderArrow($rcv['data']['body']['player']['name']);
            $data =
            [
                'data' => $cmd_data
            ];
            $p_param->setSendStack($data);
        }

        return null;
    };
}
                    </pre><br />
                </div>

                <a id="last"></a>
                <h2 class="subtitle">おわりに</h2>

                <div class="text-block">
                    Websocketサーバー上でイベントが取得できるようになっただけでもかなり負担が減らせるので助かります。<br />
                    座標計算等の処理もサーバーサイドのスクリプトで自由に組める事と、WebブラウザをUIとして使えるメリットも大きいと思います。<br /><br />

                    機能的に物足りないところもまだ残ってはいますが、今後のマインクラフトのアップデートにも期待を持ちたいところです。
                </div>
            </div>
        </div>
    </body>
</html>
